<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de modèle</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 50px;
        }
        form {
            display: flex;
            flex-direction: column;
            width: 300px;
        }
        input, button {
            margin-bottom: 15px;
            padding: 8px;
            font-size: 14px;
        }
        #result {
            margin-top: 20px;
            color: green;
        }
        #error {
            margin-top: 20px;
            color: red;
        }
        table {
            border-spacing: 0;
        }
        th:not(:first-child), td:not(:first-child) {
            border-left: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: center;
        }
        thead tr {
            background-color: #ddd;
        }
        tr:nth-child(even) {
            background-color: #eee;
        }
    </style>
</head>
<body>
    <div style="display: flex;">
        <div style="display: flex; flex-direction: column;">
            <h2>Uploader un modèle</h2>
            <input type="text" id="model_name" placeholder="Nom du modèle" required>
            <input type="text" id="model_params" placeholder="Paramètres (ex: JSON ou texte)" required>
            <input type="file" id="fileInput" required>
            <button id="uploadBtn">Uploader</button>
            <progress style="width: 100%;" id="progressBar" value="0" max="100"></progress>
            <div id="status"></div>
        </div>

        <div style="margin-left: 50px;">
            <h2>Modèles disponibles</h2>
            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Paramètres</th>
                        <th>Taille (bytes)</th>
                    </tr>
                </thead>
                <tbody id="modelsUl">
                    <!-- Les modèles seront listés ici -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const uploadBtn = document.getElementById('uploadBtn')
        const progressBar = document.getElementById('progressBar')
        const statusDiv = document.getElementById('status')

        uploadBtn.addEventListener('click', () => {
            const name = document.getElementById('model_name').value
            const params = document.getElementById('model_params').value
            const file = document.getElementById('fileInput').files[0]

            if (!name || !params || !file) {
                statusDiv.textContent = '❌ Veuillez remplir tous les champs.'
                return
            }

            const formData = new FormData()
            formData.append('name', name)
            formData.append('params', params)
            formData.append('file', file)

            const xhr = new XMLHttpRequest()
            xhr.open('POST', `${window.location.origin}models/upload`, true)

            // Suivre la progression de l’upload
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100
                    progressBar.value = percent
                }
            }

            xhr.onload = () => {
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.responseText)
                    statusDiv.textContent = `✅ Upload réussi : ${res.name} (${res.size} octets)`
                } else {
                    const err = JSON.parse(xhr.responseText || '{}')
                    statusDiv.textContent = `❌ Erreur : ${err.error || xhr.statusText}`
                }
            }

            xhr.onerror = () => {
                statusDiv.textContent = '❌ Erreur de connexion au serveur.'
            }

            xhr.send(formData)
        })

        function getModels() {
            const form = document.getElementById('uploadForm')
            fetch(`${window.location.href}models`)
                .then(response => response.json())
                .then(data => {
                    const modelsUl = document.getElementById('modelsUl')
                    modelsUl.innerHTML = ''
                    data.forEach(model => {
                        const li = document.createElement('li')
                        li.textContent = `Nom : ${model.name}, Paramètres : ${model.params}, Taille : ${model.size} bytes`
                        const row = document.createElement('tr')
                        row.innerHTML = `<td>${model.name}</td><td>${model.params}</td><td>${model.size}</td>`
                        modelsUl.appendChild(row)
                    })
                })
                .catch(err => {
                    console.error('Erreur :', err)
                })

            setTimeout(getModels, 5000)
        }
        getModels()
    </script>
</body>
</html>